<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit ED Physicians Form</title>

    <script defer type="module">
      import {
        getVisits,
        getTreatments,
        getDepartments,
        getPhysicians,
        updateVisit,
        updatePhysicians
      } from "./js/api.js";

      const visits = await getVisits();
      const treatments = await getTreatments();
      const departments = await getDepartments();
      const physicians = await getPhysicians();

      const url = new URL(location.href);
      const id = url.searchParams.get("id");

      // Get the visit with an id that matches the query string
    //   const physician = visits.find((x) => x.ed_visit_id == id);

      physicians.forEach((physician) => {
        document.querySelector(
          `[name="emergency_physician_id"]`
        ).innerHTML += `
          <option value="${physician.emergency_physician_id}">
            ${physician.name}
          </option>
        `;
      });

      physicians.forEach((physician) => {
        document.querySelector(
          `[name="credential"]`
        ).innerHTML += `
          <option value="${physician.emergency_physician_id}">
            ${physician.credential}
          </option>
        `;
      });

    //   physicians.forEach((physician) => {
    //     const isSelected = visit.physicians.find(
    //       (x) => x.emergency_physician_id == physician.emergency_physician_id
    //     );

    //     document.querySelector(`[name="ed_visit_physician_ids"]`).innerHTML += `
    //       <option
    //         value="${physician.emergency_physician_id}"
    //         ${isSelected ? "selected" : ""}
    //       >
    //         ${physician.name}
    //       </option>
    //     `;
    //   });

      // Populate the form with existing data
      for (const key in physician) {
        const input = document.querySelector(
          `#edit-physician-form [name='${key}']`
        );

        if (input) {
          input.value = visit[key];
        }
      }

      document
        .querySelector("#edit-physician-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const data = {
            emergency_physician_id: id,
          };
          document
            .querySelectorAll(`#edit-physician-form [name]`)
            .forEach((input) => {
              data[input.name] = input.value;
            });

          const physicianList = document.querySelector(
            "[name='ed_visit_physician_id']"
          );
          data.ed_visit_physician_id = [...physicianList.selectedOptions].map(
            (x) => x.value
          );

          await updateVisit(data);
        });
    </script>
  </head>
  <body>
    <header>
      <nav>
        <a href="index.html">Home</a>
        <a href="HospitalRegions.html">HospitalRegions</a>
        <a href="EmergencyDepartments.html">EmergencyDepartments</a>
        <a href="EmergencyPhysicians.html">EmergencyPhysicians</a>
        <a href="Patients.html">Patients</a>
        <a href="Treatments.html">Treatments</a>
        <a href="EDVisits.html">EDVisits</a>
      </nav>
    </header>
    <main>
      <h2>Edit ED Physicians Form</h2>
      <form id="edit-physician-form" action="/visits" method="put">

        <label>
            Add/Remove Physicians
            <select name="ed_visit_physician_ids" multiple>
              <!-- <option value="1">Dr. Katy Price</option> -->
            </select>
        </label>

        <!-- <label> -->
          <!-- Emergency Department:
          <select name="emergency_department_id">
              <option value="1">Department 1</option>
          </select>
        </label>
        <br />
        <br />
        <label>
          Patient ID:
          <input type="text" name="patient_id" />
        </label>
        <br />
        <br />
        <label>
          Date:
          <input type="text" name="date_of_visit" />
        </label>
        <br />
        <br />
        <label>
          Admit Time:
          <input type="text" name="admit_time" />
        </label>
        <br />
        <br />
        <label> -->

          Credential:
          <select name="credential">
            <!-- <option value="null">No Treatment Rendered</option> -->
            <!-- <option value="3">Amoxicillin</option> -->
          </select>
        </label>
        <br />
        <br />

     
        <input type="submit" value="Submit" />
      </form>
    </main>
  </body>
</html>
